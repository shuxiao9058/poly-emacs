#+title: Addons

Configuration for addons, additional features provided by individual packages.

#+begin_src emacs-lisp
  ;;; -*- lexical-binding: t -*-
#+end_src

* Git integration with magit & diff-hl & smerge

To manage the git repository, use builtin package ~vc~.

#+begin_src emacs-lisp
(use-package with-editor
    :straight t
    :ensure t)

(use-package emacsql
    :straight t
    :ensure t)

(use-package magit
    :straight t
    :commands (magit-file-delete magit-status magit-checkout)
    :hook (magit-pop-mode . hide-mode-line-mode)
    :custom
    ;; (magit-refresh-verbose t) ;; debug only
    ;; (magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1)
    (magit-revert-buffers 'silent)
    (git-commit-summary-max-length 50)
    (magit-log-section-commit-count 5)
    (magit-diff-options (quote ("--minimal" "--patience")))
    (magit-tag-arguments (quote ("--annotate" "--sign")))
    (magit-merge-arguments (quote ("--no-ff")))
    (magit-rebase-arguments (quote ("--autostash")))
    ;; use colored graph lines. Could be a performance issue.
    (magit-log-arguments (quote ("-n64" "--graph" "--decorate" "--color" "--stat")))
    (magit-diff-use-overlays nil)
    (magit-use-overlays nil)
    (magit-auto-revert-mode nil)
    (git-rebase-auto-advance  nil)
    (magit-stage-all-confirm nil)
    (magit-commit-squash-commit 'marked-or-curren)
    (magit-push-always-verify ni) ;; cuz it says so
    (magit-diff-refine-hunk nil)
    (git-commit-finish-query-functions nil)
    (magit-log-section-commit-count 10)
    (magit-log-section-arguments '("--graph" "--decorate" "--color"))
    ;; (magit-log-margin '(t "%Y-%m-%d %H:%M:%S" magit-log-margin-width t 18))
    (magit-log-margin  '(t "%m/%d/%Y %H:%M " magit-log-margin-width t 18))
    ;; (magit-log-margin-show-committer-date t)
    ;; (magit-git-executable "/usr/local/bin/git")
    :init
    ;; Must be set early to prevent ~/.emacs.d/transient from being created
    (setq transient-levels-file  (concat poly-etc-dir "transient/levels")
	  transient-values-file  (concat poly-etc-dir "transient/values")
	  transient-history-file (concat poly-etc-dir "transient/history"))

    ;; Have magit-status go full screen and quit to previous
    ;; configuration.  Taken from
    ;; http://whattheemacsd.com/setup-magit.el-01.html#comment-748135498
    ;; and http://irreal.org/blog/?p=2253
    (defadvice magit-status (around magit-fullscreen activate)
      (window-configuration-to-register :magit-fullscreen)
      ad-do-it
      (delete-other-windows))
    (defadvice magit-quit-window (after magit-restore-screen activate)
      (jump-to-register :magit-fullscreen))
    ;; (setq
    ;; ;; Use flyspell in the commit buffer
    ;; (add-hook 'git-commit-setup-hook 'git-commit-turn-on-flyspell)
    :config
    (setq magit-status-sections-hook
	  '(
	    magit-insert-status-headers
	    magit-insert-merge-log
	    magit-insert-rebase-sequence
	    ;; magit-insert-am-sequence
	    ;; magit-insert-sequencer-sequence
	    ;; magit-insert-bisect-output
	    ;; magit-insert-bisect-rest
	    ;; magit-insert-bisect-log
	    magit-insert-untracked-files
	    magit-insert-unstaged-changes
	    magit-insert-staged-changes
	    magit-insert-unpushed-cherries
	    magit-insert-stashes
	    ;; magit-insert-recent-commits
	    magit-insert-unpulled-from-pushremote
	    magit-insert-unpushed-to-upstream
	    ;; magit-insert-unpushed-to-pushremote
	    ;; magit-insert-unpulled-from-upstream
	    ))

    (setq magit-status-headers-hook
	  '(
	    ;; magit-insert-repo-header
	    magit-insert-remote-header
	    ;; magit-insert-error-header
	    magit-insert-diff-filter-header
	    magit-insert-head-branch-header
	    magit-insert-upstream-branch-header
	    magit-insert-push-branch-header
	    magit-insert-tags-header
	    ))

    (setq magit-refresh-status-buffer nil)
    (setq auto-revert-buffer-list-filter
	  'magit-auto-revert-repository-buffer-p)
    (remove-hook 'magit-refs-sections-hook 'magit-insert-tags)
    (remove-hook 'server-switch-hook 'magit-commit-diff)

    ;; Opening repo externally
    (defun poly/parse-repo-url (url)
      "convert a git remote location as a HTTP URL"
      (if (string-match "^http" url)
	  url
	(replace-regexp-in-string "\\(.*\\)@\\(.*\\):\\(.*\\)\\(\\.git?\\)"
				  (concat (if (string-match "17usoft.com" url) "http" "https") "://\\2/\\3")
				  url)))
    (defun poly/magit-open-repo ()
      "open remote repo URL"
      (interactive)
      (let ((url (magit-get "remote" "origin" "url")))
	(progn
	  (browse-url (poly/parse-repo-url url))
	  (message "opening repo %s" url))))

    (defun m/magit-display-buffer-traditional (buffer)
      "Like magit-display-buffer-traditional, but re-uses window for status mode, too."
      (display-buffer
       buffer (if (not (memq (with-current-buffer buffer major-mode)
			     '(magit-process-mode
			       magit-revision-mode
			       magit-diff-mode
			       magit-stash-mode
			       magit-status-mode)))
		  '(display-buffer-same-window)
		nil)))

    (setq magit-display-buffer-function 'm/magit-display-buffer-traditional)

    (defun m/magit-reset-author (&optional args)
      "Resets the authorship information for the last commit"
      (interactive)
      (magit-run-git-async "commit" "--amend" "--no-edit" "--reset-author"))

    ;; (magit-define-popup-action 'magit-commit-popup
    ;;   ?R "Reset author" 'm/magit-reset-author)
    (transient-append-suffix 'magit-commit
	"S"
      '("R" "Reset author" m/magit-reset-author))
    :bind
    (:map transient-base-map
	  ("q" . transient-quit-one)
	  ("<escape>" . transient-quit-one))
    (:map transient-edit-map
	  ("q" . transient-quit-one)
	  ("<escape>" . transient-quit-one))
    (:map transient-sticky-map
	  ("q" . transient-quit-one)
	  ("<escape>" . transient-quit-one)))

(use-package magit-gitflow
    :straight t
    :after magit
    :commands magit-gitflow-popup
    :hook (magit-mode . turn-on-magit-gitflow)
    )

;; ;; Show TODOs in magit
;; (use-package magit-todos
;;     :straight t
;;     :diminish
;;     :after magit
;;     :config
;;     (magit-todos-mode))

;; git-gutter-plus - View, stage and revert Git changes from the buffer (inspired by package of same name from vim)
(use-package git-gutter+
    :straight t
    :diminish git-gutter+-mode
    :demand t
    :bind (("C-c g n" . git-gutter+-next-hunk)
	   ("C-c g p" . git-gutter+-previous-hunk))
    :config
    (defun git-gutter+-remote-default-directory (dir file)
      (let* ((vec (tramp-dissect-file-name file))
             (method (tramp-file-name-method vec))
             (user (tramp-file-name-user vec))
             (domain (tramp-file-name-domain vec))
             (host (tramp-file-name-host vec))
             (port (tramp-file-name-port vec)))
	(tramp-make-tramp-file-name method user domain host port dir)))

    (defun git-gutter+-remote-file-path (dir file)
      (let ((file (tramp-file-name-localname (tramp-dissect-file-name file))))
	(replace-regexp-in-string (concat "\\`" dir) "" file)))
    (global-git-gutter+-mode)
    )

(use-package git-gutter-fringe+ :straight t)

;; git-messenger - Provides a function popup commit message at current line (port of package of same name from vim)
(use-package git-messenger
    :straight t
    :bind ("C-c g p" . git-messenger:popup-message)
    :init
    (custom-set-variables
     '(git-messenger:use-magit-popup t))
    (setq git-messenger:show-detail t)
    :config
    (progn
      (define-key git-messenger-map (kbd "RET") 'git-messenger:popup-close)))

;; git-timemachine - Step through historic versions of a git controlled file
(use-package git-timemachine
    :straight t
    :bind ("C-c g t" . git-timemachine-toggle))

;; gitignore-mode - Major mode for various Git configuration files
(use-package git-modes :straight t)

;; browse-at-remote - Browse target page on github/gitlab/bitbucket
(use-package browse-at-remote
    :straight t
    :bind ("C-c g b" . browse-at-remote/browse))

;; based on http://manuel-uberti.github.io/emacs/2018/02/17/magit-bury-buffer/
(defun magit-kill-buffers ()
  "Restore window configuration and kill all Magit buffers."
  (interactive)
  (let ((buffers (magit-mode-get-buffers)))
    (magit-restore-window-configuration)
    (mapc #'kill-buffer buffers)))

;; required by forge
(use-package yaml
    :straight t)

(use-package forge
    :straight t
    :after (magit yaml)
    :commands forge-create-pullreq forge-create-issue
    :custom
    (forge-database-file (expand-file-name "forge/forge-database.sqlite" poly-etc-dir))
    (custom-set-variables '(forge-post-mode-hook '(visual-line-mode)))
    (forge-bug-reference-hooks
     '(git-commit-setup-hook magit-mode-hook))
    :config
    (setq forge-alist
	  (append forge-alist
		  '(("git.17usoft.com" "git.17usoft.com/api/v4" "git.17usoft.com" forge-gitlab-repository)
		    ("github.com" "api.github.com" "github.com" forge-github-repository))))
    ;; ;; remove some hooks for magit performance-s
    ;; (remove-hook 'magit-status-sections-hook 'forge-insert-pullreqs)
    ;; (remove-hook 'magit-status-sections-hook 'forge-insert-issues)
    )

(use-package ghub
    :straight t
    :after (magit forge)
    ;; :custom
    ;; (ghub-insecure-hosts '("git.17usoft.com/api/v4"))
    )

(use-package smerge-mode
    :straight t
    :ensure t
    :diminish
    :commands (smerge-mode
               smerge-auto-leave
               smerge-next
               smerge-prev
               smerge-keep-base
               smerge-keep-upper
               smerge-keep-lower
               smerge-keep-all
               smerge-keep-current
               smerge-keep-current
               smerge-diff-base-upper
               smerge-diff-upper-lower
               smerge-diff-base-lower
               smerge-refine
               smerge-ediff
               smerge-combine-with-next
               smerge-resolve
               smerge-kill-current)
    :after (hydra magit)
    :hook ((find-file . (lambda ()
                          (save-excursion
                            (goto-char (point-min))
                            (when (re-search-forward "^<<<<<<< " nil t)
                              (smerge-mode 1)))))

	   ( magit-diff-visit-file . (lambda ()
				       (when smerge-mode
					 (hydra-smerge/body))))))

(use-package vdiff
    :straight t)

;; (use-package magit-delta
;;   :straight t
;;   :delight
;;   :if (executable-find "delta")
;;   :hook ((magit-mode . magit-delta-mode))
;;   :custom
;;   ( magit-delta-delta-args
;;     '("--max-line-distance" "0.6" "--24-bit-color" "always" "--color-only" "--dark" ;; "--diff-so-fancy"
;;       ;; "--no-gitconfig"
;;       )))

(use-package code-review
    :straight t
    :bind (:map forge-topic-mode-map
		("C-c r" . code-review-forge-pr-at-point))
    :custom
    (code-review-db-database-file (expand-file-name "code-review-db.sqlite" poly-cache-dir))
    (code-review-log-file (expand-file-name "code-review-error.log" poly-cache-dir))
    :config
    (setq code-review-gitlab-host "git.17usoft.com/api")
    (setq code-review-gitlab-baseurl "git.17usoft.com")
    (setq code-review-gitlab-graphql-host "git.17usoft.com/api"))
#+end_src

Enable diff-hl in based on major modes.

#+begin_src emacs-lisp
  (straight-use-package 'diff-hl)
  (autoload 'diff-hl-mode "diff-hl" nil t)
  (autoload 'diff-hl-dired-mode "diff-hl-dired" nil t)

  (add-hook 'dired-mode-hook 'diff-hl-dired-mode)
  (add-hook 'prog-mode-hook 'diff-hl-mode)
  (add-hook 'conf-mode-hook 'diff-hl-mode)
#+end_src

* Input method with emacs-rime

~librime~ is required for this feature.

~emacs-rime~ is the frontend of rime built with emacs input method API.

#+begin_src emacs-lisp

  (defun +rime-predicate-is-back-quote-or-tilde ()
    (or (equal rime--current-input-key ?`)
        (equal rime--current-input-key ?~)))

  (use-package rime
    :straight (rime
               :host github
               :repo "DogLooksGood/emacs-rime"
               :files (:defaults "lib.c" "Makefile"))
    :defer t
    :custom
    ;; Disable input method in non-insert state.
    (rime-disable-predicates '(rime-predicate-prog-in-code-p
                               rime-predicate-after-alphabet-char-p
                               meow-normal-mode-p
                               meow-motion-mode-p
                               meow-keypad-mode-p))
    ;; Auto switch to inline ascii state when after a space after a non-ascii character.
    (rime-inline-predicates '(rime-predicate-space-after-cc-p
                              +rime-predicate-is-back-quote-or-tilde
                              rime-predicate-current-uppercase-letter-p))
    (rime-translate-keybindings '("C-f" "C-b" "C-n" "C-p" "C-g"))
    (default-input-method "rime")
    ;; (rime-cursor "Ë°")
    ;; (rime-librime-root (concat user-emacs-directory "librime/dist"))
    (rime-librime-root "/opt/local")
    (rime-emacs-module-header-root "/opt/local/include/emacs-mac")
    ;; (rime-show-candidate 'minibuffer)
    (rime-show-preedit t)
    (rime-show-candidate 'posframe)
    ;; (rime-show-candidate 'minibuffer)
    ;; (rime-posframe-properties (list :background-color "#202325"
    ;; 				  :foreground-color "#ddddde" ;; "#dedddd"
    ;; 				  :internal-border-width 6))
    ;; (rime-code-face
    ;;  '((t (:inherit default :background "#ffffff" :foreground "#000000"))))
    ;; (rime-disable-predicates
    ;;  '(evil-normal-state-p
    ;;    rime--after-alphabet-char-p
    ;;    rime--prog-in-code-p
    ;;    ))
    ;; (rime-share-data-dir "")
    (rime-user-data-dir (expand-file-name "rime" poly-local-dir))
    :bind
    (:map rime-active-mode-map
          ("<tab>" . rime-inline-ascii)
          :map rime-mode-map
          ("C-$" . rime-send-keybinding)
          ("M-j" . rime-force-enable)))
#+end_src

* Telegram client with Telega

~telegram-libtd~ is required for this feature.

Use Telega as Telegram client.

#+begin_src emacs-lisp
  (straight-use-package 'telega)

  (autoload 'telega "telega" nil t)

;;  (global-set-key (kbd "C-c a t") 'telega)

  (with-eval-after-load "telega"
    (set-face-attribute 'telega-entity-type-code nil :family 'unspecfied :inherit 'fixed-pitch-serif)
    (set-face-attribute 'telega-entity-type-pre nil :family 'unspecfied :inherit 'fixed-pitch-serif)
    (define-key telega-msg-button-map (kbd "SPC") nil))
#+end_src

Proxy setup

#+begin_src emacs-lisp
  (when (and
         (bound-and-true-p meomacs-socks5-proxy-host)
         (bound-and-true-p meomacs-socks5-proxy-port))
    (setq telega-proxies
          `((:server ,meomacs-socks5-proxy-host :port ,meomacs-socks5-proxy-port
                     :enable t :type (:@type "proxyTypeSocks5")))))
#+end_src

* Password management with pass

Manage password with pass

Adding following to ~$HOME/.gnupg/gpg-agent.conf~.

#+begin_example
  allow-emacs-pinentry
  allow-loopback-pinentry
#+end_example

Open pass menu with =C-c a p=.

#+begin_src emacs-lisp
  (straight-use-package 'pass)
  (straight-use-package 'pinentry)

  (setq pass-username-fallback-on-filename t
        pass-show-keybindings nil)

  (autoload #'pass "pass" nil t)

;;  (global-set-key (kbd "C-c a p") 'pass)

  (with-eval-after-load "pass"
    (pinentry-start))
#+end_src

* Directory environment support with direnv

#+begin_src emacs-lisp
  (straight-use-package 'direnv)

  (setq direnv-always-show-summary nil)

  (define-key toggle-map "e" 'direnv-mode)

  (autoload 'direnv-mode "direnv" nil t)
#+end_src
