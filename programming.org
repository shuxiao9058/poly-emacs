#+title: Programming

Configuration for programming and languages support.

#+begin_src emacs-lisp
  ;;; -*- lexical-binding: t -*-
#+end_src

* Format

#+begin_src emacs-lisp
(use-package format-all
  :straight t
  :ensure t
  :hook ((
	  fish-mode
	  sh-mode
	  ;; prog-mode
	  ;; lua-mode
	  go-mode
	  go-ts-mode
	  go-mod-ts-mode
	  python-mode
	  python-ts-mode
	  java-mode
	  cc-mode
	  c-mode
	  c++-mode
	  clang-mode
	  elisp-mode
	  emacs-lisp-mode
	  ;; markdown-mode
	  yaml-mode
	  nix-mode
	  protobuf-mode
	  nginx-mode
	  cperl-mode
	  clojure-mode
	  ;;  objc-mode
	  ;;  swift-mode
	  ;;  typescript-mode
	  ;;  web-mode
	  ) . format-all-mode)
  :commands (format-all-mode
	     format-all-buffer)
  :init
  (defconst format-all--system-type
    (cl-case system-type
      (windows-nt 'windows)
      (cygwin     'windows)
      (darwin     'macos)
      (gnu/linux  'linux)
      (berkeley-unix
       (save-match-data
	 (let ((case-fold-search t))
	   (cond ((string-match "freebsd" system-configuration) 'freebsd)
		 ((string-match "openbsd" system-configuration) 'openbsd)
		 ((string-match "netbsd"  system-configuration) 'netbsd))))))
    "Current operating system according to the format-all package.")

  (defun format-all--resolve-system (choices)
    "Get first choice matching `format-all--system-type' from CHOICES."
    (cl-dolist (choice choices)
      (cond ((atom choice)
	     (cl-return choice))
	    ((eql format-all--system-type (car choice))
	     (cl-return (cadr choice))))))
  :config
  (define-format-all-formatter cpp-lua-format
			       (:executable "lua-format")
			       (:install (macos ""))
			       (:languages "Lua")
			       (:features)
			       (:format (format-all--buffer-easy executable "-i" "-c" (expand-file-name "~/.config/lua-format/config.yaml") "--")))

  (define-format-all-formatter my-clang-format
			       (:executable "clang-format")
			       (:install
				(macos "brew install clang-format")
				(windows "scoop install llvm"))
			       (:languages "C" "C++" "Java" "Objective-C" "Protocol Buffer")
			       (:features)
			       (:format
				(format-all--buffer-easy
				 executable
				 (concat "-assume-filename="
					 (or (buffer-file-name)
					     (cdr (assoc language
							 '(("C"               . ".c")
							   ("C++"             . ".cpp")
							   ("Java"            . ".java")
							   ("Objective-C"     . ".m")
							   ("Objective-C" . ".x")
							   ("Objective-C" . ".xm")
							   ("Objective-C" . ".m")
							   ("Objective-C" . ".mm")
							   ("Protocol Buffer" . ".proto")))))))))

  (define-format-all-formatter goimports-gofmt
			       (:executable "/bin/sh")
			       (:install
				(macos "brew install go")
				(windows "scoop install go")
				"go get golang.org/x/tools/cmd/goimports")
			       (:languages "Go")
			       (:features)
			       (:format (format-all--buffer-easy executable "-c" "goimports | gofmt -s")))


  (define-format-all-formatter goimports
			       (:executable "goimports")
			       (:install (macos ""))
			       (:languages "Go")
			       (:features)
			       (:format (format-all--buffer-easy executable)))

  (define-format-all-formatter gofumpt
			       (:executable "gofumpt")
			       ;; (:executable "/bin/sh")
			       (:install (macos ""))
			       (:languages "Go")
			       (:features)
			       (:format (format-all--buffer-easy executable)))

  (define-format-all-formatter py-autopep8
			       (:executable "autopep8")
			       (:install (macos ""))
			       (:languages "Python")
			       (:features)
			       (:format (format-all--buffer-easy executable "-")))

  (define-format-all-formatter py-black
			       (:executable "black")
			       (:install (macos ""))
			       (:languages "Python")
			       (:features)
			       (:format (format-all--buffer-easy executable "-")))

  (define-format-all-formatter my-shfmt
			       (:executable "shfmt")
			       (:install
				(macos "brew install shfmt")
				(windows "scoop install shfmt"))
			       (:languages "Shell")
			       (:features)
			       (:format
				(format-all--buffer-easy executable "-i" "4" "-ci"
							 (if (buffer-file-name)
							     (list "-filename" (buffer-file-name))
							   (list "-ln"
								 (cl-case (and (eql major-mode 'sh-mode)
									       (boundp 'sh-shell)
									       (symbol-value 'sh-shell))
								   (bash "bash")
								   (mksh "mksh")
								   (t "posix")))))))

  (define-format-all-formatter my-beautysh
			       (:executable "beautysh")
			       (:install
				(macos "pip install beautysh"))
			       (:languages "Shell")
			       (:features)
			       (:format (format-all--buffer-easy executable "-")))


  (define-format-all-formatter nginxfmt
			       (:executable "nginxfmt")
			       (:install (macos "pip install nginxfmt"))
			       ;; (:install
			       ;;  (macos "brew install shfmt")
			       ;;  (windows "scoop install shfmt"))
			       (:languages "_Nginx")
			       ;; (:modes nginx-mode)
			       (:features)
			       (:format
				(format-all--buffer-easy executable "-i" "4" "-")))

  (define-format-all-formatter crossplane
			       (:executable "/usr/local/bin/nginx_format.sh")
			       (:install (macos "pip install crossplane"))
			       (:languages "Nginx")
			       (:features)
			       ;; (:modes nginx-mode)
			       (:format (format-all--buffer-easy executable)))

  ;; lsp-format-buffer
  (eval-after-load 'format-all
    (dolist (hook '(;; lua-mode-hook
		    go-mode-hook
		    go-ts-mode-hook
		    go-mod-ts-mode-hook
		    python-mode-hook
		    python-ts-mode-hook
		    java-mode-hook
		    markdown-mode-hook
		    ;; cc-mode-hook
		    ;; c-mode-hook
		    ;; c++-mode-hook
		    ;; clang-mode-hook
		    ;; objc-mode-hook
		    nginx-mode-hook
		    emacs-lisp-mode-hook
		    markdown-mode-hook
		    fish-mode-hook
		    protobuf-mode-hook))
      (add-hook hook 'format-all-ensure-formatter)))

  (setq-default format-all-formatters
		'(
		  ("Go" gofumpt)
		  ;; ("Go" goimports)
		  ;; ("Lua" stylua)
		  ("Java" my-clang-format)
		  ("Markdown" prettier)
		  ("C" my-clang-format)
		  ("C++" my-clang-format)
		  ;; ("Objective-C" my-clang-format)
		  ("Protocol Buffer" my-clang-format)
		  ("SQL" pgformatter)
		  ;; ("CSS" prettier)
		  ;; ("HTML" prettier)
		  ;; ("Dockerfile" dockfmt)
		  ;; ("Shell" my-shfmt)
		  ;; ("Python" py-autopep8)
		  ("Python" py-black)
		  ("Shell" my-beautysh)
		  ;; ("Markdown" prettier)
		  ;; ("Nix" nixpkgs-fmt)
		  ;; ("Emacs Lisp" emacs-lisp)
		  ;; ("YAML" prettier)
		  ("Nginx" nginx-fmt)
		  )))
#+end_src

* Flycheck

#+begin_src emacs-lisp
(use-package flycheck
  :straight t
  :ensure t
  :init (global-flycheck-mode)
  :custom
  (flycheck-check-syntax-automatically
   '(save idle-change mode-enabled))
  (flycheck-checker-error-threshold nil))

(use-package flycheck-color-mode-line
  :straight t
  :hook (flycheck-mode-hook . flycheck-color-mode-line-mode))

;; https://github.com/hlissner/doom-emacs/issues/2194
;; underline cant be a different color than the foreground on terminal
;; set foreground color to red on terminals to compensate
;; This doesnt take into account emacs running with frames both in the
;; terminal and GUI but im not worried about that situation.
;; https://stackoverflow.com/a/5801740
;; TODO: fix multi line errors not showing anything in terminal
;; this was changed as a result of https://github.com/flycheck/flycheck/issues/1730
(add-hook 'flycheck-mode-hook
          (defun fix-flycheck-error-face ()
            (unless window-system
              (set-face-attribute 'flycheck-error nil :foreground "red")
              (set-face-attribute 'flycheck-warning nil :foreground "yellow")
              (set-face-attribute 'flycheck-info nil :foreground "yellow"))))

(setq tooltip-frame-parameters
        '((name . "tooltip")
          (internal-border-width . 6)
          (border-width . 0)
          (no-special-glyphs . t)))

(setq tooltip-delay 0.5)
(setq tooltip-short-delay 0.5)
#+end_src

* flymake

#+begin_src emacs-lisp
(use-package flymake
  :straight (:type built-in))
#+end_src

* LSP

** eglot

Use eglot as LSP client.

#+begin_src emacs-lisp
(defun project-name (project)
  "A human-readable name for the project.
	Nominally unique, but not enforced."
  (file-name-nondirectory (directory-file-name (project-root project))))

;; https://github.com/DEbling/dotfiles/blob/9dc0e347267dd68111baf8e7ab7d33c2e39ed404/.emacs.d/elisp/lang-java.el
;; (defconst jdt-jar-path "~/.emacs.d/.local/jar/org.eclipse.equinox.launcher.jar")
;; (defconst jdt-jar-path "/opt/jdt-language-server/plugins/org.eclipse.equinox.launcher_1.6.0.v20200915-1508.jar")
(defconst jdt-jar-path (expand-file-name "jdt-language-server/plugins/org.eclipse.equinox.launcher_1.6.400.v20210924-0641.jar" "~/workspace"))
(defconst jdt-extra-jvm-args '("-noverify"
			       "-javaagent:/Users/jiya/workspace/dotemacs.d/.local/jar/lombok.jar"
			       ;; "-javaagent:[~/.emacs.d/.local/jar/lombok.jar][classes=META-INF/]"
			       "-Xbootclasspath/a:~/.config/emacs/.local/jar/lombok.jar"
			       "--add-modules=ALL-SYSTEM"
			       "--add-opens"
			       "java.base/java.util=ALL-UNNAMED"
			       "--add-opens"
			       "java.base/java.lang=ALL-UNNAMED"
			       ;; "-configuration"
			       ;; "/opt/jdt-language-server/config_mac"
			       ))

(defun my-eclipse-jdt-contact (interactive)
  "Contact with the jdt server.
If INTERACTIVE, prompt user for details."
  (let* ((cp (getenv "CLASSPATH"))
	 (contact (unwind-protect (progn
				    (setenv "CLASSPATH" jdt-jar-path)
				    (eglot--eclipse-jdt-contact interactive))
		    (setenv "CLASSPATH" cp)))
	 (jdt-class (car contact))
	 (args (cddr contact)))
    (append (list jdt-class "/usr/bin/java")
	    jdt-extra-jvm-args args)))

(defun dart-lsp-contact (interactive)
  (list (executable-find "dart")
	(concat (file-name-directory (nix-executable-find nil "dart"))
		"snapshots/analysis_server.dart.snapshot")
	"--lsp"
	"--client-id=emacs.eglot"))

(use-package eglot
  :straight (:type built-in)
  :unless poly-use-lsp-mode
  :hook ((go-mode
	  go-ts-mode
	  protobuf-ts-mode
	  js-json-mode
	  json-mode
	  json-ts-mode
	  css-ts-mode
	  css-mode
	  lua-mode
	  lua-ts-mode
	  typescript-mode
	  typescript-ts-mode
	  tsx-ts-mode
	  html-ts-mode
	  html-mode
	  beancount-mode
	  python-mode
	  python-ts-mode
	  clojure-mode
	  clojurescript-mode
	  js-mode typescript-mode
	  c-mode c++-mode objc-mode swift-mode
	  java-mode ) . eglot-ensure)
  :custom
  (eglot-autoshutdown t)
  (eglot-sync-connect 1)
  (eglot-connect-timeout 40)
  (eglot-send-changes-idle-time 0.5)
  (eglot-confirm-server-initiated-edits nil)
  (eglot-events-buffer-size 500000)
  ;; (eglot-events-buffer-size 0)
  ;; disable symbol highlighting and documentation on hover
  ;; (eglot-ignored-server-capabilites
  ;;  '(:documentHighlightProvider
  ;;    :signatureHelpProvider
  ;;    :hoverProvider))
  ;; NOTE We disable eglot-auto-display-help-buffer because :select t in
  ;; its popup rule causes eglot to steal focus too often.
  (eglot-auto-display-help-buffer nil)
  :functions eglot--eclipse-jdt-contact
  :config
  (setq eglot-stay-out-of '(imenu eldoc))  ;; eglot reinits backends
  (setq eldoc-echo-area-use-multiline-p nil)
  ;; https://github.com/abougouffa/minemacs/blob/693efa0788fbe60e2f836d27aa12c7c055a2c387/elisp/%2Beglot.el#L27
  (defun +eglot-register (modes &rest servers)
    "Register MODES with LSP SERVERS.
Examples:
  (+eglot-register 'vhdl-mode \"vhdl_ls\")
  (+eglot-register 'lua-mode \"lua-language-server\" \"lua-lsp\")
  (+eglot-register '(c-mode c++-mode) '(\"clangd\" \"--clang-tidy\" \"-j=12\") \"ccls\")"
    (declare (indent 0))
    (let* ((alternatives-p (length> servers 1))
           (first-server (car servers))
           (first-server (if (listp first-server) (car first-server) first-server)))
      (with-eval-after-load 'eglot
	(when (executable-find first-server)
          (add-to-list
           'eglot-server-programs
           (cons modes (if alternatives-p
                           (eglot-alternatives (ensure-list servers))
			 (ensure-list (car servers)))))))))
  ;; emmylua
  ;; (let ((emmylua-jar-path (f-join (poly/vscode-extension-install-path "tangzx.emmylua") "server/EmmyLua-LS-all.jar")))
  ;;    (add-to-list 'eglot-server-programs
  ;; 		 `((lua-mode lua-ts-mode)  . ("/Library/Java/JavaVirtualMachines/openjdk8-zulu/Contents/Home/bin/java" "-cp" ,emmylua-jar-path
  ;; 					      "com.tang.vscode.MainKt" "-XX:+UseG1GC" "-XX:+UseStringDeduplication"))))

  ;; (let* ((lua-language-server-dir (poly/vscode-extension-install-path "sumneko.lua"))
  ;; 	 (lua-language-server-main (expand-file-name "server/main.lua" lua-language-server-dir))
  ;; 	 (lua-language-server-exec (expand-file-name "server/bin/lua-language-server" lua-language-server-dir)))
  ;;   (+eglot-register 'lua-mode `(,lua-language-server-exec "-E" "-e" "LANG=en" ,lua-language-server-main)))

  (let* ((lua-language-server-dir "/opt/local/lib/lua-language-server")
	 (lua-language-server-main (expand-file-name "main.lua" lua-language-server-dir))
	 (lua-language-server-exec (expand-file-name "bin/lua-language-server" lua-language-server-dir)))
    (+eglot-register 'lua-mode `(,lua-language-server-exec "-E" "-e" "LANG=en" ,lua-language-server-main "--logpath=/tmp/lua-language-server/log/" "--metapath=/tmp/lua-language-server/meta/" "--develop=false")))

  (let ((json-language-main (expand-file-name "json-language-features/server/dist/node/jsonServerMain.js" poly-vscode-app-extension-path)))
    (+eglot-register '(js-json-mode json-ts-mode json-mode) `("/opt/local/bin/node" ,json-language-main "--stdio")))

  ;; (let ((ts-language-main (expand-file-name "node_modules/typescript/lib/tsserver.js" poly-vscode-app-extension-path)))
  ;;   (+eglot-register '(js-mode js-ts-mode tsx-ts-mode typescript-ts-mode typescript-mode) `("/opt/local/bin/node" ,ts-language-main "--stdio")))

  (let ((css-language-main (expand-file-name "css-language-features/server/dist/node/cssServerMain.js" poly-vscode-app-extension-path)))
    (+eglot-register '(css-ts-mode css-mode) `("/opt/local/bin/node" ,css-language-main "--stdio")))

  (let ((html-language-main (expand-file-name "html-language-features/server/dist/node/htmlServerMain.js" poly-vscode-app-extension-path)))
    (+eglot-register '(html-ts-mode html-mode) `("/opt/local/bin/node" ,html-language-main "--stdio")))

  (+eglot-register '(go-mode go-ts-mode) `("gopls"))

  (setq-default js-indent-level 2)
  (add-to-list 'auto-mode-alist '("\\.ts\\'" . typescript-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.tsx\\'" . tsx-ts-mode))
  (+eglot-register '(js-mode js-ts-mode tsx-ts-mode typescript-ts-mode typescript-mode) '("typescript-language-server" "--stdio"))

  (add-to-list 'eglot-server-programs
	       '(java-mode .  my-eclipse-jdt-contact))

  (add-to-list 'eglot-server-programs
	       `(beancount-mode .  ("beancount-language-server")))

  (add-to-list 'eglot-server-programs
	       '(dart-mode . dart-lsp-contact))

  (when (executable-find "ccls")
    (add-to-list 'eglot-server-programs '((c-mode c++-mode objc-mode) "ccls"
					  "-init={\"compilationDatabaseDirectory\":\"build\"}")))

  (when (executable-find "pyright-langserver")
    (add-to-list 'eglot-server-programs '((python-ts-mode) "pyright-langserver"
					  "--stdio" "--watch")))

  (when (executable-find "protobuf-language-server")
    (add-to-list 'eglot-server-programs '((protobuf-mode protobuf-ts-mode) "protobuf-language-server"
					  )))

  (add-to-list 'eglot-server-programs
	       `((swift-mode) ,(string-trim (shell-command-to-string "xcrun --find sourcekit-lsp"))))

  (add-hook 'eglot-managed-mode-hook
	    (lambda()
	      (progn
		;; (flymake-mode -1)
		(poly/set-lsp-capf)
		)))

  (setq eglot-workspace-configuration
	`((:gopls . ((staticcheck . :json-false)
		     (matcher . "CaseSensitive")
		     (gofumpt . t)
		     (usePlaceholders . t)
		     (completeUnimported . t)
		     (deepCompletion . t)
		     (completionBudget . "150ms")
		     (diagnosticsDelay  .  "800ms")
		     (vulncheck . "Imports")
		     (semanticTokens . t)
		     ;; (directoryFilters . ["-vendor"])
		     (annotations . ((bounds . t) (escape . t) (inline . t) (nil . t)))
		     (codelenses . ((gc_details . :json-false)
				    (generate . t)
				    (regenerate_cgo . t)
				    (tidy . t)
				    (upgrade_dependency . t)
				    (vendor . t)))
		     ;; (buildFlags . ["-mod=vendor"])
		     (allowImplicitNetworkAccess . t)
		     (allowModfileModifications . t)
		     (experimentalPostfixCompletions . t)
		     (analyses . ,(mapcar (lambda (a) (cons a :json-false))
					  '(unusedparams unusedwrite composites ST1003  ST1021 ST1016 SA5011 ST1020 ST1005 SA9003 SA4006 ST1022 S1023 SA4011 SA4010 ST1018)))))
	  (:Lua . ((format . ((defaultConfig . ((indent_style . "space") (indent_size . "2")))))
				   (completion . ((callSnippet . "Both")))
				   (hint . ((arrayIndex . "Auto") (enable . t)))))
	  ))
  :bind (:map eglot-mode-map
	      ("C-c C-r" . poly/eglot-rename)
	      ("C-c o" . eglot-code-action-organize-imports)
	      ("C-c h" . eldoc)
	      ("<f6>" . xref-find-definitions)
	      ("C-c C-a" . eglot-code-actions)
	      ("C-c C-f" . eglot-format-buffer)))

(defun poly/go-workspace-organize-imports()
  "Run organize-imports action in workspace with changed go files."
  (interactive)
  (save-excursion
    (when-let ((filename (buffer-file-name))
	       (directory-name (file-name-directory filename))
	       (files (magit-changed-files "HEAD")))
      (dolist (go-file files)
	(when (s-suffix? ".go" go-file)
	  (let* ((full-filename (expand-file-name go-file directory-name))
		 (buffer (find-file-noselect full-filename))
		 (results))
	    (when buffer
	      (with-current-buffer buffer
		(when (fboundp 'eglot-code-action-organize-imports)
		  (setq results (call-interactively 'eglot-code-action-organize-imports (point-min)))
		  (when results
		    (let ((el (seq-elt results 0))
			  (edit)
			  (idx 0))
		      (when (< idx (length results))
			(setq edit (plist-get el :edit))
			(if edit
			    (eglot--apply-workspace-edit edit)
			  (message (format "nothing need to import: %s" go-file)))
			(setq el (seq-elt results idx))
			(setq idx (1+ idx))))))
		(message (format "organize imports & save buffer: %s" go-file))
		(save-buffer))
	      )))))))

(defun lsp/non-greedy-eglot ()
  "Making Eglot capf non-greedy."
  (progn
    (fset 'non-greedy-eglot
	  (cape-capf-buster
	   (cape-capf-properties #'eglot-completion-at-point :exclusive 'no)))
    (setq completion-at-point-functions
	  (list #'non-greedy-eglot))))

(defun lsp/extra-capf ()
  "Adding extra capf during LSP startup."
  (let ((tmp-symbol (intern (concat "capf/" (symbol-name major-mode)))))
    (unless (null (symbol-function tmp-symbol))
      (funcall (symbol-function tmp-symbol)))))
#+end_src

*** eglot-rename with symbol in place

#+begin_src emacs-lisp
(defun poly/eglot-rename (newname)
  "Rename the current symbol to NEWNAME."
  (interactive
   (list (read-from-minibuffer
          (format "Rename `%s' to: " (or (thing-at-point 'symbol t)
                                         "unknown symbol"))
          (or (thing-at-point 'symbol t) "") nil nil nil
          (symbol-name (symbol-at-point)))))
  (unless (eglot--server-capable :renameProvider)
    (eglot--error "Server can't rename!"))
  (eglot--apply-workspace-edit
   (jsonrpc-request (eglot--current-server-or-lose)
                    :textDocument/rename `(,@(eglot--TextDocumentPositionParams)
                                           :newName ,newname))
   current-prefix-arg))
#+end_src

** lsp-mode

#+begin_src emacs-lisp
(defvar my-disable-lsp-completion nil
  "If non-nil, disable lsp-completion-enable, can work with .dir-locals
       ((nil . ((eval . (setq-local my-disable-lsp-completion t)))))
    .")

(defun my/local-variables-hook()
  "disable lsp-completion-enable"
  (when (bound-and-true-p my-disable-lsp-completion)
    (setq-local lsp-completion-enable nil
		;; lsp-modeline-code-actions-enable nil
		))
  (when (derived-mode-p 'go-mode
			'go-ts-mode
			'go-mod-ts-mode
			'java-mode
			'beancount-mode
			'web-mode
			;; 'python-mode
			'lua-mode
			'lua-ts-mode
			'scala-mode
			'js-mode
			'js2-mode
			'typescript-mode
			'c-mode
			'c++-mode
			'clojure-mode
			'cperl-mode
			'go-dot-mod-mode
			'perl-mode)
    ;; ;; https://github.com/golang/tools/commit/b2d8b0336
    ;; (setq-local lsp-completion-filter-on-incomplete nil)
    (lsp-deferred)))

(defun set-lsp-priority (client priority)
  "Change the PRIORITY of lsp CLIENT."
  (require 'lsp-mode)
  (if-let (client (gethash client lsp-clients))
      (setf (lsp--client-priority client)
            priority)
    (error "No LSP client named %S" client)))

;; (with-eval-after-load 'lsp-lua
;; (set-lsp-priority 'lua-language-server 1)
;; )

(use-package lsp-mode
  :straight t
  :when poly-use-lsp-mode
  :diminish
  :commands (lsp lsp-deferred lsp-enable-which-key-integration lsp-format-buffer lsp-organize-imports)
  :hook ( ((go-mode go-ts-mode go-dot-mod-mode go-mod-ts-mode
		    java-mode
		    beancount-mode web-mode
		    ;; 'python-mode
		    lua-mode lua-ts-mode
		    scala-mode js-mode
		    js2-mode typescript-mode typescript-ts-mode
		    c-mode c++-mode clojure-mode cperl-mode
		    shell-mode bash-mode markdown-mode sql-mode
		    yaml-mode xml-mode nxml-mode
		    ) . lsp-deferred)
	  (lsp-mode . lsp-enable-which-key-integration))
  :custom
  (lsp-restart 'auto-restart)
  ;; (lsp-restart 'ignore)
  (lsp-auto-configure t)
  (lsp-auto-execute-action nil)
  (lsp-apply-edits-after-file-operations  nil)
  (lsp-enable-links nil)
  (lsp-idle-delay 0.1)                 ;; lazy refresh
  (lsp-server-trace nil)
  (lsp-log-io t)
  ;; (lsp-log-max nil)
  (lsp-print-performance nil)
  (lsp-document-sync-method nil) ;; use default method recommended by server. 'incremental 'full
  (lsp-enable-xref t)
  (lsp-auto-touch-files nil)
  (lsp-modeline-code-actions-segments '(count name))
  (lsp-modeline-code-actions-enable nil)
  (lsp-modeline-diagnostics-enable nil)
  (lsp-modeline-diagnostics-scope :file)
  (lsp-modeline-workspace-status-enable nil)
  (lsp-headerline-breadcrumb-enable nil)
  (lsp-semantic-tokens-enable t)
  (lsp-progress-spinner-type 'progress-bar-filled)
  ;; (lsp-diagnostics-provider :none)
  (lsp-diagnostics-provider :flycheck)
  (lsp-diagnostic-clean-after-change nil)
  (lsp-enable-indentation nil)
  (lsp-completion-enable t)
  (lsp-completion-enable-additional-text-edit nil)
  (lsp-response-timeout 5)
  (lsp-tcp-connection-timeout 2)
  (lsp-enable-folding nil)             ;; use `evil-matchit' instead
  ;; (lsp-diagnostic-package :none)   ;; prefer flycheck disable
  (lsp-diagnostic-package :flycheck)   ;; prefer flycheck disable
  (lsp-modeline-diagnostics-enable nil)
  (lsp-diagnostics-disabled-modes '(js-mode go-mode))
  (lsp-flycheck-live-reporting nil)    ;; obey `flycheck-check-syntax-automatically'
  (lsp-completion-provider :none)    ;; set company-backends manually
  (lsp-enable-file-watchers nil)       ;; turn off for better performance
  ;; (lsp-file-watch-threshold 10000)
  (lsp-enable-text-document-color nil) ;; as above
  (lsp-enable-symbol-highlighting nil) ;; as above
  (lsp-enable-on-type-formatting nil)  ;; disable formatting on the fly
  (lsp-diagnostics-disabled-modes '(markdown-mode gfm-mode))
  ;; ( lsp-clients-python-library-directories '("/usr/local/" "/usr/")))
  (lsp-before-save-edits nil)
  (lsp-auto-guess-root t)              ;; auto guess root
  (lsp-keep-workspace-alive nil)       ;; auto kill lsp server
  (lsp-signature-auto-activate nil) ; nil
  (lsp-signature-render-documentation nil)
  (lsp-eldoc-enable-hover nil)         ;; disable eldoc displays in minibuffer
  (lsp-eldoc-render-all nil)
  (lsp-enable-snippet t)
  (lsp-enable-imenu t)
  (lsp-enable-links nil) ;;
  (lsp-lens-enable t)
  (lsp-prefer-flymake nil) ;; Use lsp-ui and flycheck
  (lsp-imenu-container-name-separator "â¦¿")
  (lsp-imenu-show-container-name t)
  (lsp-clients-emmy-lua-java-path "/Library/Java/JavaVirtualMachines/openjdk8-zulu/Contents/Home/bin/java")
  (lsp-clients-emmy-lua-jar-path (f-join (poly/vscode-extension-install-path "tangzx.emmylua") "server/EmmyLua-LS-all.jar"))
  (lsp-clients-emmy-lua-args '("com.tang.vscode.MainKt" "-XX:+UseG1GC" "-XX:+UseStringDeduplication"))
  (lsp-clients-lua-language-server-install-dir (poly/vscode-extension-install-path "sumneko.lua"))
  (lsp-clients-lua-language-server-bin (expand-file-name "server/bin/lua-language-server" lsp-clients-lua-language-server-install-dir))
  (lsp-clients-lua-language-server-args '("-E"))
  (lsp-clients-lua-language-server-main-location (expand-file-name "server/main.lua" lsp-clients-lua-language-server-install-dir))
  (lsp-lua-workspace-max-preload 4096); Default: 300, Max preloaded files
  (lsp-lua-workspace-preload-file-size 1024) ; Default: 100, Skip files larger than this value (KB) when preloading.
  (lsp-lua-diagnostics-globals "'Lua.diagnostics.globals': ['use', 'awesome', 'client', 'root']")
  (lsp-lua-completion-enable nil)
  (lsp-lua-diagnostics-disable t)
  (lsp-lua-diagnostics-enable nil)
  (lsp-lua-hint-enable nil)
  (lsp-lua-hint-param-name nil)
  (lsp-lua-hint-param-type nil)
  (lsp-lua-hover-enable nil)
  (lsp-lua-signature-help-enable nil)
  (lsp-lua-window-progress-bar nil)
  (lsp-lua-window-status-bar nil)
  (lsp-lua-completion-display-context nil)
  ;; (lsp-go-gopls-server-path "/usr/local/gopath/bin/gopls")
  (lsp-go-gopls-server-path "/opt/local/bin/gopls")
  ;; (lsp-gopls-server-args '("-debug" "127.0.0.1:3000" "-logfile=/tmp/gopls-emacs.log" ;; "-rpc.trace" "-vv"
  ;; 			   ))
  (lsp-go-hover-kind "NoDocumentation")
  (lsp-go-links-in-hover nil)
  (lsp-go-use-gofumpt t)
  (lsp-go-use-placeholders t)
  (lsp-go-symbol-matcher "FastFuzzy")
  ;; (lsp-go-env '((GOFLAGS . "-mod=mod")))
  (lsp-go-directory-filters ["-_bazel_out"
			     "-_bazel_bin"
			     "-_bazel_testlogs"
			     "-_bazel_infrastructure"
			     "-bazel-out"
			     "-bazel-bin"
			     "-bazel-testlogs"
			     "-bazel-infrastructure"
			     "-tools"
			     "-**/testdata"
			     "-vendor"
			     "-internal"
			     "-.gocache"
			     "-.git"
			     "-!out"
			     ])
  (lsp-beancount-langserver-executable (expand-file-name "workspace/beancount-language-server/target/release/beancount-language-server" "~"))
  (lsp-beancount-journal-file (expand-file-name ".emacs.d/.local/beancount/beancount.beancount" "~"))
  ;; :init
  ;; ;; Buffer local variable for storing number of lines.
  ;; (defvar lsp--log-lines)
  :config
  (add-to-list 'lsp-disabled-clients '(emmy-lua))
  (add-to-list 'lsp-enabled-clients '(lua-language-server
				      pyright gopls
				      json-ls beancount-ls css-ls dockerfile-ls ts-ls
				      html-ls nginx-ls bash-ls unified sqls yamlls xmlls taplo))
  (add-to-list 'lsp-file-watch-ignored "[/\\\\]\\vendor$")
  (add-to-list 'lsp-file-watch-ignored "[/\\\\].git$")
  (add-to-list 'lsp-file-watch-ignored "[/\\\\]internal$")
  (add-to-list 'lsp-file-watch-ignored "[/\\\\]\\.gocache$")
  (add-hook 'hack-local-variables-hook #'my/local-variables-hook)
  (lsp-register-custom-settings
   `(("gopls.usePlaceholders" t t)
     ("gopls.deepCompletion" t t)
     ("gopls.completeUnimported" t t)
     ("gopls.staticcheck" ,(if (executable-find "staticcheck") t nil) t)
     ("gopls.completionBudget" "200ms" nil)
     ("gopls.semanticTokens" t t)
     ("gopls.allExperiments" t t)
     ("gopls.matcher" "Fuzzy" t)
     ("gopls.hoverKind" "NoDocumentation" nil)
     ("gopls.codelenses"  ((gc_details . :json-false)
			   (generate . t)
			   (regenerate_cgo . t)
			   (tidy . t)
			   (upgrade_dependency . t)
			   (vendor . t)) nil)
     ;;disables -mod=readonly, allowing imports from out-of-scope module
     ("gopls.allowModfileModifications" t t)
     ("gopls.vulncheck" "Imports" nil)
     ;;disables GOPROXY=off, allowing implicit module downloads rather than requiring user action
     ("gopls.allowImplicitNetworkAccess" t t)
     ;; ST1003 CamelCase
     ;; ST1021 comment on exported type
     ;; ST1016 methods on the same type should have the same receiver name
     ;; ST1020 comment on exported function
     ;; ST1005 error strings should not be capitalized
     ;; SA9003 empty branch
     ;; ST1022 comment on exported var
     ;; S1023 redundant break statement
     ;; SA4011 ineffective break statement. Did you mean to break out of the outer loop?
     ;; SA4010 this result of append is never used, except maybe in other appends
     ;; S1007 should use raw string (`...`) with regexp.Compile to avoid having to escape twice
     ("gopls.analyses" ,(mapcar (lambda (a) (cons a :json-false))
				'(unusedparams composites ST1003  ST1021 ST1016 SA5011 ST1020 ST1005 SA9003 SA4006 ST1022 S1023 SA4011 SA4010)))
     ("gopls.annotations" ,(mapcar (lambda (a) (cons a :json-false))
				   '(bounds escape inline nil)))
     ;; ("gopls.buildFlags" ["-mod=readonly"])
     ("gopls.env" lsp-go-env)
     ("gopls.linkTarget" lsp-go-link-target)
     ("gopls.gofumpt" ,(if (executable-find "gofumpt") t nil) t)
     ("gopls.experimentalPostfixCompletions" t t)
     ("gopls.semanticTokens" t t)
     ("gopls.directoryFilters" lsp-go-directory-filters)
     ;; ("gopls.directoryFilters" ["-vendor" "-internal" "-.gocache" "-.git" "-!out"])
     ("Lua.runtime.version" "LuaJIT" t)
     ("Lua.workspace.checkThirdParty" nil t)
     ("Lua.completion.enable" t t)
     ("Lua.completion.callSnippet" "Both" t)
     ("Lua.format.enable" t t)
     ("Lua.hint.enable" t t)
     ("Lua.hint.hover" t t)
     ("Lua.hint.arrayIndex" "Auto" t)
     ("Lua.format.defaultConfig.indent_style" "space" t)
     ("Lua.format.defaultConfig.indent_size" "2" t)
     ))


  ;; ;; cancel warning
  ;; (advice-add 'lsp-warn
  ;; 	      :around (lambda (orig-func &rest r)
  ;; 			(message (apply #'format-message r))))
  :bind (:map lsp-mode-map
	      ("C-c r" . lsp-rename)
	      ("C-c a" . lsp-organize-imports)
	      ("C-c C-f" . poly/lsp-format-buffer)
	      ([remap xref-find-definitions] . lsp-find-definition)
              ([remap xref-find-references] . lsp-find-references))
  )

(use-package lsp-pyright
  :ensure t
  :straight t
  :after lsp-mode
  :hook (python-mode . (lambda ()
                         (require 'lsp-pyright)
                         (lsp-deferred)))
  :config
  (add-to-list 'lsp-enabled-clients 'lsp-pyright)
  )

(use-package dap-mode
  :straight t
  :when poly-use-lsp-mode
  :ensure t
  :after lsp-mode
  :config
  (dap-auto-configure-mode)
  ;; (dap-mode t)
  (dap-ui-mode t)
  (require 'dap-go)
  (require 'dap-dlv-go)
  (require 'dap-chrome)
  (require 'dap-hydra)
  )

(use-package lsp-treemacs
  :when poly-use-lsp-mode
  :straight t
  :after lsp-mode
  :commands lsp-treemacs-errors-list)

(use-package lsp-ui
  :straight t
  :after lsp-mode
  :when poly-use-lsp-mode
  :diminish
  :custom-face
  (lsp-ui-sideline-code-action ((t (:inherit warning))))
  :hook (lsp . lsp-ui-mode)
  :custom
  (lsp-ui-doc-enable nil)
  (lsp-ui-doc-header nil)
  (lsp-ui-doc-max-height 45)
  (lsp-ui-doc-include-signature t)
  (lsp-ui-doc-position 'top)
  (lsp-ui-doc-alignment 'frame)
  ;; (lsp-ui-doc-position 'at-point)
  (lsp-ui-doc-border (face-foreground 'default))
  (lsp-ui-sideline-enable t)
  (lsp-ui-sideline-ignore-duplicate t)
  (lsp-ui-sideline-show-code-actions t)
  (lsp-ui-sideline-show-diagnostics t)
  (lsp-ui-doc-use-childframe nil)
  (lsp-ui-doc-use-webkit nil)
  (lsp-ui-doc-show-with-cursor nil)
  (lsp-ui-imenu-window-width 200)
  (lsp-ui-doc-border (face-foreground 'font-lock-comment-face))
  (lsp-ui-imenu-colors `(,(face-foreground 'font-lock-keyword-face)
			 ,(face-foreground 'font-lock-string-face)
			 ,(face-foreground 'font-lock-constant-face)
			 ,(face-foreground 'font-lock-variable-name-face)))
  :config
  ;; ;; Use lsp-ui-doc-webkit only in GUI
  ;; (when IS-GUI
  ;;   (setq lsp-ui-doc-use-webkit t))
  ;; WORKAROUND Hide mode-line of the lsp-ui-imenu buffer
  ;; https://github.com/emacs-lsp/lsp-ui/issues/243
  (defadvice lsp-ui-imenu (after hide-lsp-ui-imenu-mode-line activate)
    (setq mode-line-format nil))
  :bind (
	 :map lsp-ui-mode-map
	 ("M-<f6>" . lsp-ui-hydra/body)))
#+end_src

** yas parameter complete in place required


#+begin_src emacs-lisp
(use-package yasnippet-snippets
  :straight t
  :ensure t
  :config
  (add-to-list 'yas-snippet-dirs
	       (expand-file-name "snippets" poly-cache-dir) t))

(use-package yasnippet
  :straight t
  :ensure t
  :diminish yas-global-mode
  :commands yas-global-mode
  :hook (after-init . yas-global-mode)
  ;; :hook ((typescript-mode . yas-minor-mode)
  ;;        (sh-mode . yas-minor-mode)
  ;;        (c-mode . yas-minor-mode)
  ;;        (c++-mode . yas-minor-mode)
  ;;        (go-mode . yas-minor-mode)
  ;;        (json-mode . yas-minor-mode)
  ;;        (yaml-mode . yas-minor-mode)
  ;;        (web-mode . yas-minor-mode)
  ;;        (js2-mode . yas-minor-mode)
  ;; 	 (lua-mode . yas-minor-mode))
  :after (yasnippet-snippets)
  :config
  ;; (message "config yasnippet")
  (yas-reload-all))

(use-package java-snippets
  :straight t
  :defer t
  :after yasnippet)

(use-package javadoc-lookup
  :straight t)
#+end_src

* treesitter

#+begin_src emacs-lisp
(when (and (fboundp 'treesit-available-p) (treesit-available-p))
  (require 'treesit))

(use-package treesit
  :straight (:type built-in)
  :commands treesit-font-lock-rules treesit-font-lock-recompute-features
  :init
  (setq treesit-language-source-alist
        '((bash . ("https://github.com/tree-sitter/tree-sitter-bash"))
          (c . ("https://github.com/tree-sitter/tree-sitter-c"))
          (cmake . ("https://github.com/uyha/tree-sitter-cmake"))
          (cpp . ("https://github.com/tree-sitter/tree-sitter-cpp"))
          (css . ("https://github.com/tree-sitter/tree-sitter-css"))
          (c-sharp . ("https://github.com/tree-sitter/tree-sitter-c-sharp"))
          (go . ("https://github.com/tree-sitter/tree-sitter-go"))
          (html . ("https://github.com/tree-sitter/tree-sitter-html"))
          (java . ("https://github.com/tree-sitter/tree-sitter-java"))
          (javascript . ("https://github.com/tree-sitter/tree-sitter-javascript"))
          (json . ("https://github.com/tree-sitter/tree-sitter-json"))
          (lua . ("https://github.com/Azganoth/tree-sitter-lua"))
          (make . ("https://github.com/alemuller/tree-sitter-make"))
          (ocaml . ("https://github.com/tree-sitter/tree-sitter-ocaml" nil "ocaml/src"))
          (python . ("https://github.com/tree-sitter/tree-sitter-python"))
          (php . ("https://github.com/tree-sitter/tree-sitter-php"))
          (typescript . ("https://github.com/tree-sitter/tree-sitter-typescript" nil "typescript/src"))
          (ruby . ("https://github.com/tree-sitter/tree-sitter-ruby"))
          (rust . ("https://github.com/tree-sitter/tree-sitter-rust"))
          (sql . ("https://github.com/m-novikov/tree-sitter-sql"))
          (toml . ("https://github.com/tree-sitter/tree-sitter-toml"))
          (yaml . ("https://github.com/ikatyang/tree-sitter-yaml"))
	  (protobuf . ("https://github.com/mitchellh/tree-sitter-proto"))
          (zig . ("https://github.com/GrayJack/tree-sitter-zig"))))
  (setq major-mode-remap-alist
	'((c-mode . c-ts-mode)
	  (c++-mode . c++-ts-mode)
	  (c-or-c++-mode . c-or-c++-ts-mode)
	  (python-mode . python-ts-mode)
	  (csharp-mode . csharp-ts-mode)
	  (cmake-mode . cmake-ts-mode)
	  (dockerfile-mode . dockerfile-ts-mode)
	  (go-mode . go-ts-mode)
	  (json-mode . json-ts-mode)
	  ;; (lua-mode . lua-ts-mode)
	  (json-mode . json-ts-mode)
	  (css-mode . css-ts-mode)
	  (java-mode . java-ts-mode)
	  (rust-mode . rust-ts-mode)
	  (ruby-mode . ruby-ts-mode)
	  (typescript-mode . typescript-ts-mode)
	  (conf-toml-mode . toml-ts-mode)
	  (yaml-mode . yaml-ts-mode)
	  ;; (protobuf-mode . protobuf-ts-mode)
	  ))
  :config
  (add-to-list 'treesit-extra-load-path (expand-file-name "tree-sitter" user-emacs-directory))
  (defun poly/treesit-install-all-languages ()
    "Install all languages specified in `treesit-language-source-alist'."
    (interactive)
    (let ((languages (mapcar 'car treesit-language-source-alist)))
      (dolist (lang languages)
        (treesit-install-language-grammar lang)
        (message "`%s' parser was installed." lang)
        (sit-for 0.75))))
  (advice-add
   'treesit--install-language-grammar-1
   :around
   (lambda (old-function out-dir &rest arguments)
     (apply old-function (car treesit-extra-load-path) arguments)))
  :hook
  (c-ts-mode .
	     (lambda()
	       (setq-local treesit-font-lock-level 4)
	       (setq-local
		treesit-font-lock-settings
		(append
		 treesit-font-lock-settings
		 (treesit-font-lock-rules
		  :language 'c
		  :feature 'func
		  '((call_expression
		     function:
		     (identifier) @font-lock-property-face
		     arguments: (_))))))))
  (java-ts-mode .
		(lambda()
		  (setq-local
		   treesit-font-lock-settings
		   (append
		    treesit-font-lock-settings
		    (treesit-font-lock-rules
		     :language 'java
		     :feature 'expression
		     :override t
		     '((method_invocation
			name: (identifier) @font-lock-property-face)))))))
  (go-ts-mode
   .
   (lambda()
     (setq-local treesit-font-lock-level 4)
     (treesit-font-lock-recompute-features '(property bracket delimiter operator variable function attribute import import func))))
  (python-ts-mode
   .
   (lambda()
     (setq-local treesit-font-lock-level 4)
     (treesit-font-lock-recompute-features '(property bracket delimiter operator variable function attribute import))))
  ;; :custom
  ;; (treesit--font-lock-verbose t)
  )


(add-hook 'prog-mode-hook #'general-ts-mode-setup)
(add-hook 'c-ts-mode-hook #'c-ts-setup)
(add-hook 'css-ts-mode-hook 'ts-css-setup)

(defun poly/lsp-format-buffer()
  (if (bound-and-true-p lsp-mode)
      (lsp-format-buffer)
    (when (bound-and-true-p eglot--managed-mode)
      (eglot-format-buffer))))

(defun lsp-format-buffer-on-save ()
  (add-hook 'before-save-hook
	    #'poly/lsp-format-buffer -10 t))

(dolist (hook '(go-ts-mode-hook lua-mode-hook typescript-ts-mode-hook))
  (add-hook hook #'lsp-format-buffer-on-save))

(defun general-ts-mode-setup ()
  (treesit-font-lock-recompute-features
   nil
   '(property bracket delimiter operator variable function)))

(defun c-ts-setup ()
  (setq-local electric-quote-comment nil)
  (setq-local electric-quote-string nil)
  (indent-tabs-mode)
  (bug-reference-prog-mode)
  (setq-local fill-paragraph-function #'ts-c-fill-paragraph)
  (treesit-font-lock-recompute-features '(emacs-devel)))

(defun ts-c-fill-paragraph (&optional arg)
  (interactive)
  (let ((node (treesit-node-at (point))))
    (when (equal (treesit-node-type node) "comment")
      (fill-region
       (treesit-node-start node) (treesit-node-end node)))
    t))

(defun ts-css-setup ()
  (treesit-font-lock-recompute-features nil '(variable function)))
#+end_src

* Languages
** cc-mode
#+begin_src emacs-lisp
(use-package cc-mode
  :straight t
  :ensure t
  :mode (
	 ("\\.c\\'" . c-mode)
         ("\\.h\\'" . c-mode)
	 ("\\.cxx\\'" . c++-mode)
         ("\\.cpp\\'" . c++-mode)
         ("\\.hpp\\'" . c++-mode)
	 ("\\.x\\'" . objc-mode)
	 ("\\.xm\\'" . objc-mode)
	 ("\\.m\\'" . objc-mode)
	 ("\\.mm\\'" . objc-mode)

	 ;; ("\\.c" . c-mode)
         ;; ("\\.h" . c-mode)
         ;; ("\\.cpp" . c++-mode)
         ;; ("\\.hpp" . c++-mode)
	 ;; ("\\.h\\(h\\|xx\\|pp\\)\\'" . c++-mode)
         ;; ("\\.tpp\\'" . c++-mode)
	 )
  :custom
  (c-offsets-alist '((inline-open           . 0)
                     (brace-list-open       . 0)
                     (inextern-lang         . 0)
                     (statement-case-open   . 4)
                     (access-label          . -)
                     (case-label            . 0)
                     (member-init-intro     . +)
                     (topmost-intro         . 0)
                     (inlambda              . 0) ;; better indentation for lambda
                     (innamespace           . 0) ;; no indentation after namespace
                     (arglist-cont-nonempty . +)))
  ;; :config
  ;; (with-eval-after-load 'lsp-mode
  ;;   (setq lsp-clients-clangd-args
  ;;         '("-j=2"
  ;;           "--background-index"
  ;;           "--clang-tidy"
  ;;           "--completion-style=bundled"
  ;;           "--pch-storage=memory"
  ;;           "--suggest-missing-includes")))
  )

(use-package modern-cpp-font-lock
  :straight t
  :ensure t
  :hook (c++-mode . modern-c++-font-lock-mode))


(use-package cmake-mode
  :straight t
  :ensure t
  ;; :defines (company-backends)
  :mode (("CMakeLists\\.txt\\'" . cmake-mode)
         ("\\.cmake\\'" . cmake-mode))
  ;; :config
  ;; (with-eval-after-load 'company-mode
  ;;   (add-to-list 'company-backends 'company-cmake))
  )

;; (use-package clang-format
;;   :straight t
;;   :defer t
;;   ;; :load-path "site-lisp"
;;   :commands (clang-format-buffer)
;;   ;; :config
;;   ;; (setq clang-format-style-option "file")
;;   ;; ;; (bind-key "C-c <down>" 'clang-format-buffer c-mode-base-map)
;;   ;; :bind (:map c-mode-base-map
;;   ;;             ("C-c <down>" . clang-format-buffer)
;;   ;;             )
;;   )

(use-package cpp-auto-include
  :straight   (cpp-auto-include
               :host github
               :repo "emacsorphanage/cpp-auto-include")
  :commands (cpp-auto-include)
  )
#+end_src
** Go Language
#+begin_src emacs-lisp
  (defun poly/install-go-tool (pkg)
    "Install or update go PKG/tools."
    (interactive)
    (unless (executable-find "go")
      (user-error "Unable to find `go' in `exec-path'!"))
    (message "Installing go tool...")
    (set-process-sentinel
     (start-process "go-tool" "*Go Tool*" "go" "install" "-v" "-x" (concat pkg "@latest"))
     (lambda (proc _)
       (let ((status (process-exit-status proc)))
	 (if (= 0 status)
	     (message "Installed %s" pkg)
	   (message "Failed to install %s: %d" pkg status))))))

  (use-package go-mode
    :disabled t
    :straight t
    :ensure t
    :commands (godoc gofmt gofmt-before-save)
    :after (eglot)
    :config
    ;; Optional: install eglot-format-buffer as a save hook.
    ;; The depth of -10 places this before eglot's willSave notification,
    ;; so that that notification reports the actual contents that will be saved.
    (defun eglot-format-buffer-on-save ()
      (add-hook 'before-save-hook #'eglot-format-buffer -10 t))
    (add-hook 'go-mode-hook #'eglot-format-buffer-on-save))

  (use-package gorepl-mode
    :straight t
    :after go-mode
    :commands gorepl-run-load-current-file)

  ;; Install: See https://github.com/golangci/golangci-lint#install
  ;; (use-package flycheck-golangci-lint
  ;;   :straight t
  ;;   :after (flycheck go-mode)
  ;;   ;; :hook (go-mode . flycheck-golangci-lint-setup)
  ;;   :hook (go-mode . (lambda ()
  ;; 		     "Enable golangci-lint."
  ;; 		     (setq flycheck-disabled-checkers '(go-gofmt
  ;; 							go-golint
  ;; 							go-vet
  ;; 							go-build
  ;; 							go-test
  ;; 							go-staticcheck
  ;; 							go-errcheck))
  ;; 		     (flycheck-golangci-lint-setup)))
  ;;   :defines flycheck-disabled-checkers
  ;;   :custom
  ;;   ;; (flycheck-golangci-lint-enable-all t)
  ;;   ;; (flycheck-golangci-lint-fast t)
  ;;   (flycheck-golangci-lint-config
  ;;    (expand-file-name "golangci.yml" "~/.config/golangci-lint"))
  ;;   ;; (flycheck-golangci-lint-tests t)
  ;;   :config
  ;;   (eval-after-load 'flycheck
  ;;     '(add-hook 'flycheck-mode-hook #'flycheck-golangci-lint-setup))
  ;;   )

  (use-package go-eldoc
    :straight t
    :after go-mode
    :ensure t
    :disabled
    :commands go-eldoc-setup
    :init
    (add-hook 'go-mode-hook #'go-eldoc-setup))

  (use-package go-rename
    :straight t
    :after go-mode
    :disabled
    :ensure t
    :commands go-rename)

  (use-package go-guru
    :straight t
    :after go-mode
    :disabled
    :ensure t
    :commands go-guru-hl-identifier-mode
    :init
    (add-hook 'go-mode-hook #'go-guru-hl-identifier-mode))

  ;; (use-package go-mod-mode
  ;;     :straight (:host github :repo "zkry/go-mod-mode")
  ;;     :ensure t
  ;;     :mode (("go\\.mod\\'" . go-mod-mode)))

  (use-package go-tag
    :straight t
    :bind (:map go-mode-map
		("C-c t a" . go-tag-add)
		("C-c t r" . go-tag-remove))
    :init (setq go-tag-args (list "-transform" "camelcase"))
    :config
    (unless (executable-find "gomodifytags")
      (poly/install-go-tool "github.com/fatih/gomodifytags")))

  (use-package go-fill-struct
    :straight t
    :after go-mode
    :config
    ;; fillstruct - fills a struct literal with default values
    (unless (executable-find "fillstruct")
      (poly/install-go-tool "github.com/davidrjenni/reftools/cmd/fillstruct")))

  (use-package go-dlv
    :straight t
    :after go-mode
    :config
    ;; Delve is a debugger for the Go programming language.
    (unless (executable-find "dlv")
      (poly/install-go-tool "github.com/go-delve/delve/cmd/dlv")))

  (use-package go-errcheck
    :straight t
    :after go-mode
    :bind (:map go-mode-map
		("C-c C-e" . go-errcheck))
    :config
    ;; errcheck is a program for checking for unchecked errors in Go code.
    (unless (executable-find "errcheck")
      (poly/install-go-tool "github.com/kisielk/errcheck")))

  (use-package go-gen-test
    :straight t
    :bind (:map go-mode-map
		("C-c t g" . go-gen-test-dwim)))

  (use-package go-impl
    :straight t
    :commands (go-impl)
    :after go-mode
    :config
    (unless (executable-find "impl")
      (poly/install-go-tool "github.com/josharian/impl")))

  (use-package gotest
    :straight t
    :custom
    (go-test-verbose t)
    :bind (:map go-mode-map
		("C-c t f" . go-test-current-file)
		("C-c t t" . go-test-current-test)
		("C-c t j" . go-test-current-project)
		("C-c t b" . go-test-current-benchmark)
		("C-c t c" . go-test-current-coverage)
		("C-c t x" . go-run)))

  (use-package go-playground
    :straight t
    :diminish
    :commands (go-playground-mode)
    :config
    (unless (executable-find "goplay")
      (poly/install-go-tool "github.com/haya14busa/goplay/cmd/goplay")))
#+end_src
* lisp

#+begin_src emacs-lisp
(use-package lisp-mode
  :straight nil
  :after paredit
  :ensure nil
  :defer t
  :config
  (defun init-lisp-mode ()
    (setq lisp-body-indent 2)
    (show-paren-mode t)
    (setq show-paren-delay 0)
    (make-variable-buffer-local 'show-paren-style)
    (setq show-paren-style 'parenthesis) ; or parenthesis/expression
    (enable-paredit-mode)
    (setq abbrev-mode t)
    (setq lisp-indent-function 'common-lisp-indent-function))
  :hook
  (lisp-mode . init-lisp-mode)
  (emacs-lisp-mode . init-lisp-mode))
#+end_src

* Lua

#+begin_src emacs-lisp
(use-package lua-mode
  :straight t
  :ensure t
  :defer t
  :custom
  (lua-indent-level 2)
  ;; (lua-indent-level tab-width)
  (lua-indent-string-contents t)
  ;; :hook (cua-mode . lua-mode)
  :interpreter (("lua" . lua-mode)
		("nse" . lua-mode)
		)
  :mode (("\\.lua$" . lua-mode) ("\\.nse$" . lua-mode))
  :config
  (autoload 'lua-mode "lua-mode" "Lua editing mode." t))
#+end_src

* Tramp

#+begin_src emacs-lisp
(use-package tramp
  :straight (:type built-in)
  :ensure t
  :custom
  (tramp-default-method "ssh")
  (remote-file-name-inhibit-cache t)
  :config
  (customize-set-variable
   'tramp-ssh-controlmaster-options
   (concat
    " -o ControlPath=~/.ssh/ControlMaster/master-%%r@%%h:%%p "
    " -o ControlMaster=auto -o ControlPersist=yes")
   )
  (add-to-list 'tramp-default-user-alist '("ssh" "10\.181\.24\.12" "jy09901"))
  (setq tramp-verbose 6)
  (setq tramp-default-user "jy09901"
	tramp-default-host "10\.181\.24\.12"))

(use-package password-cache
  :straight (:type built-in)
  :ensure nil
  :custom
  ;; Never expire passwords
  (password-cache-expiry nil))

(use-package tramp-sh
  :straight (:type built-in)
  :ensure nil
  :custom
  ;; Use out-of-band method for big files
  (tramp-copy-size-limit (* 0.5 1024 1024))
  :config
  ;; Use the PATH from the remote
  (add-to-list 'tramp-remote-path 'tramp-own-remote-path))

(use-package tramp-gvfs
  :straight (:type built-in)
  :ensure nil
  :if (not IS-MAC)
  ;; :after tramp-ftp
  :config
  ;; ;; Prefer gvfs for FTP
  ;; (add-to-list 'tramp-gvfs-methods "ftp")
  (add-to-list 'tramp-gvfs-methods "dav")
  (add-to-list 'tramp-gvfs-methods "davs"))
#+end_src

* Clojure

** clojure-mode

Use clojure-mode for basic syntax support.

#+begin_src emacs-lisp
(use-package clojure-mode
  :straight t
  :commands (clojurescript-mode)
  ;; :config
  ;; (add-hook 'clojure-mode-hook 'paredit-mode)
  )

(use-package clojure-mode-extra-font-locking
  :straight t
  :ensure t
  :after clojure-mode)

;; (use-package flycheck-clojure
;;     :straight t
;;     :ensure t
;;     :commands clojure-mode
;;     ;; :config
;;     ;; (flycheck-clojure-setup)
;;     )
#+end_src

** Cider for REPL connection

#+begin_src emacs-lisp
(use-package cider
    :straight t
    :ensure t
    :commands cider-mode
    :custom
    (cider-print-fn 'zprint)
    :hook (cider-repl-mode . paredit-mode)
    :config
    (setq nrepl-popup-stacktraces nil)
    ;; (remove-hook 'cider-mode-hook 'cider-turn-on-eldoc-mode)
    ;; (add-hook 'cider-mode-hook 'cider-turn-on-eldoc-mode)
    ;; (add-hook 'cider-repl-mode-hook 'paredit-mode)
    )
#+end_src

** Linting with flycheck-clj-kondo

#+begin_src emacs-lisp
(use-package flycheck-clj-kondo
  :straight t
  :ensure t
  :commands clojure-mode
  :hook (clojure-mode . flycheck-mode)
  ;; :config
  ;; (flycheck-clojure-setup)
  )
#+end_src


* WEB
** vue
#+begin_src emacs-lisp
(use-package vue-mode
  :straight t
  :commands (vue-mode)
  :mode "\\.vue"
  ;; :config
  ;; (set-face-background 'mmm-default-submode-face nil)
  )
#+end_src
** web-mode
#+begin_src emacs-lisp
;; è®¾ç½®ç¼©è¿çº§å«ç©ºæ ¼æ°
(defvar-local my/web-mode-offset 2)

(defun my/current-buffer-suffix()
  "Return suffix of current buffer."
  (nth 0 (cdr (split-string (buffer-name) "\\."))))

(use-package web-mode
  :straight t
  :hook
  (web-mode . (lambda()
		(if (string= (my/current-buffer-suffix) "vue")
		    (setq web-mode-style-padding 0
			  web-mode-script-padding 0))

		;; è®¾ç½®ç¼©è¿çº§å«
		(setq web-mode-markup-indent-offset my/web-mode-offset)
		(setq web-mode-css-indent-offset my/web-mode-offset)
		(setq web-mode-code-indent-offset my/web-mode-offset)
		(setq web-mode-attr-indent-offset my/web-mode-offset)))
  :mode (;; ("\\.js\\'" . web-mode)
	 ;; ("\\.jsx\\'" . web-mode)
	 ("\\.vue\\'" . web-mode)
	 ("\\.jinja\\'" . web-mode)
	 ;; ("\\.ts\\'" . web-mode)
	 ;; ("\\.tsx\\'" . web-mode)
	 ;; ("\\.html$" . web-mode)
	 )
  :custom
  (web-mode-markup-indent-offset 2)
  (web-mode-css-indent-offset 2)
  (web-mode-code-indent-offset 2)
  (web-mode-block-padding 2)
  (web-mode-comment-style 2)
  (web-mode-enable-css-colorization t)
  (web-mode-enable-auto-pairing t)
  (web-mode-enable-comment-keywords t)
  (web-mode-enable-current-element-highlight t)
  ;; (js2-basic-offset my/web-mode-offset)
  ;; (js-indent-level my/web-mode-offset)
  ;; (company-tooltip-align-annotations t)
  ;; (sgml-basic-offset my/web-mode-offset)
  )
#+end_src

** tidy
#+begin_src emacs-lisp
(defun my/setup-tide-mode ()
  "Setup tide mode used in \\<keymap\\>>."
  (interactive)
  (tide-setup)
  (flycheck-mode +1)
  (setq flycheck-check-syntax-automatically '(save mode-enabled))
  (eldoc-mode +1)
  (tide-hl-identifier-mode +1)
  ;; company is an optional dependency. You have to
  ;; install it separately via package-install
  ;; `M-x package-install [ret] company`
  ;; (company-mode +1)
  )

(defun poly/tide-before-save ()
  "Auto format for tide."
  (interactive)
  (unless (string-suffix-p ".tsx" (buffer-file-name))
    ;; (when (bound-and-true-p eglot-mode)
    ;;   (print "eglot-mode format")
    ;;   (eglot-format-buffer))
    (tide-format-before-save)
    )
  ;; (if (bound-and-true-p eglot-mode)
  ;;     (eglot-format-buffer))
  )

;; (defun poly/tide-after-save ()
;;   "Auto format for tide."
;;   (interactive)
;;   ;; (if (string-suffix-p ".tsx" (buffer-file-name))
;;   ;;     (me/pretty-quick))
;;   )

(use-package tide
  :straight t
  :commands tide-setup
  :hook
  (before-save . poly/tide-before-save)
  (typescript-mode . tide-hl-identifier-mode)
  (typescript-mode . my/setup-tide-mode)
  :after web-mode
  :custom
  (typescript-indent-level 2)
  (tide-format-options '(:indentSize 2 :tabSize 2)))
#+end_src

** typescript
#+begin_src emacs-lisp :tangle no
(use-package typescript-mode
  :straight t
  :init
  (define-derived-mode typescript-tsx-mode typescript-mode "tsx")
  :custom
  (typescript-indent-level 2)
  :hook
  ((typescript-mode . subword-mode)
   ;; (typescript-mode . lsp)
   (typescript-mode . (lambda ()
			(require 'tide)
			(tide-setup))))
  :mode
  ("\\.tsx?\\'" . typescript-tsx-mode))
#+end_src

** prettier-js
#+begin_src emacs-lisp :tangle no
(use-package prettier-js
  :straight t
  :commands (prettier-js-mode prettier)
  :custom
  (prettier-target-mode "js-mode")
  (prettier-js-args
   '("--trailing-comma" "all" "--single-quote" "--semi" "--arrow-parens" "always"))
  :hook ((js-mode . prettier-js-mode)
	 (typescript-mode . prettier-js-mode)
	 (web-mode . prettier-js-mode)))
#+end_src

** js-mode
#+begin_src emacs-lisp :tangle no
(use-package js
  :straight (:type built-in)
  :mode ("\\.js$" . js-mode)
  :hook
  (;; (js-mode . lsp)
   (js-mode . (lambda ()
		(require 'tide)
		(tide-setup)))))
#+end_src

** tagedit

#+begin_src emacs-lisp
(use-package tagedit
  :straight t
  :ensure t
  :commands tagedit-mode
  :config
  (tagedit-add-paredit-like-keybindings)
  ;; (add-hook 'web-mode-hook 'tagedit-mode)
  :hook
  (((sgml-mode html-mode) . tagedit-mode)))
#+end_src

** HTML
#+begin_src emacs-lisp
#+end_src

** Emmet
#+begin_src emacs-lisp
#+end_src

** protobuf

#+begin_src emacs-lisp
(use-package protobuf-mode
  :straight t
  :defer 1
  :config
  (defconst my-protobuf-style
    '((c-basic-offset . 2)
      (indent-tabs-mode . nil)))
  (add-hook 'protobuf-mode-hook (lambda () (c-add-style "my-style" my-protobuf-style t))))
#+end_src

** python

#+begin_src emacs-lisp
(setq python-python-command "/opt/local/bin/python")
(setq py-force-py-shell-name-p t)
#+end_src

** imenu-list

#+begin_src emacs-lisp
(use-package imenu-list
  :straight t)
#+end_src
